---
title: "Authentication"
description: "How authentication works on the BeatPass API using Laravel Sanctum."
---

## Overview

BeatPass uses **Laravel Sanctum** for SPA (single-page application) authentication. This is a **cookie-based session authentication** system designed for first-party frontend applications.

<Warning>
  BeatPass does not issue API tokens or support third-party integrations. This API is for the BeatPass web application only.
</Warning>

---

## Authentication Model

BeatPass uses **stateful SPA authentication**:

| Aspect | Implementation |
|--------|----------------|
| Method | Cookie-based sessions |
| CSRF | Required for state-changing requests |
| Tokens | Not issued (no `/sanctum/token` endpoint) |
| Third-party | Not supported |

---

## SPA Authentication Flow

The BeatPass frontend authenticates using Sanctum's SPA authentication:

<Steps>
  <Step title="Get CSRF Cookie">
    Before login, request a CSRF cookie:
    ```http
    GET /sanctum/csrf-cookie
    ```
    This sets the `XSRF-TOKEN` cookie.
  </Step>
  
  <Step title="Submit Login">
    POST credentials with the CSRF token:
    ```http
    POST /login
    Content-Type: application/json
    X-XSRF-TOKEN: {token-from-cookie}
    
    {
      "email": "user@example.com",
      "password": "your-password"
    }
    ```
  </Step>
  
  <Step title="Handle 2FA (if enabled)">
    If 2FA is enabled, you'll receive a `two_factor: true` response.
    Submit the TOTP code:
    ```http
    POST /two-factor-challenge
    
    { "code": "123456" }
    ```
  </Step>
  
  <Step title="Session Established">
    On success, a session cookie is set. All subsequent requests include this cookie automatically.
  </Step>
</Steps>

---

## CSRF Protection

<Warning>
  All state-changing requests (POST, PUT, DELETE) require CSRF protection.
</Warning>

### How CSRF Works

1. **Cookie:** Sanctum sets an `XSRF-TOKEN` cookie (URL-encoded)
2. **Header:** Include the decoded token in `X-XSRF-TOKEN` header
3. **Verification:** Laravel verifies the header matches the cookie

### JavaScript Example

```javascript
// Read CSRF token from cookie
function getCsrfToken() {
  const cookie = document.cookie
    .split('; ')
    .find(row => row.startsWith('XSRF-TOKEN='));
  return cookie ? decodeURIComponent(cookie.split('=')[1]) : null;
}

// Make authenticated request
async function apiPost(url, data) {
  const response = await fetch(url, {
    method: 'POST',
    credentials: 'include', // Include cookies
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'X-XSRF-TOKEN': getCsrfToken()
    },
    body: JSON.stringify(data)
  });
  return response.json();
}
```

### Axios Configuration

```javascript
// Axios automatically handles XSRF-TOKEN cookies
axios.defaults.withCredentials = true;
axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
```

---

## Stateful Domains

Sanctum only allows cookie authentication from configured domains:

```
localhost, localhost:3000, 127.0.0.1, beta.beatpass.ca
```

Requests from other domains will not receive authenticated sessions.

---

## Optional vs Required Auth

### Optional Auth Endpoints

Many endpoints use `optionalAuth:sanctum` middlewareâ€”they work without authentication but return more data when authenticated:

```http
GET /tracks           # Public track list
GET /tracks/{id}      # Track details (shows purchase status if authed)
GET /artists/{id}     # Artist profile (shows follow status if authed)
GET /search           # Search results
```

### Required Auth Endpoints

These endpoints require a valid token:

```http
POST /tracks                           # Upload track
PUT  /tracks/{track}                   # Update track
POST /tracks/{track}/purchase/initiate # Purchase flow
GET  /purchases                        # User purchases
GET  /messaging/conversations          # Messages
POST /beat-requests                    # Create request
GET  /producer-intelligence/dashboard  # Analytics
```

---

## Two-Factor Authentication

When 2FA is enabled, the login flow requires an additional step:

### Initial Login Response (2FA Required)

```json
{
  "two_factor": true,
  "message": "Two factor authentication required"
}
```

### Submit 2FA Code

```http
POST /two-factor-challenge
Content-Type: application/json

{
  "code": "123456"
}
```

Or use a recovery code:

```json
{
  "recovery_code": "abcd-efgh-ijkl"
}
```

---

## Token Security

### Best Practices

<AccordionGroup>
  <Accordion title="Store Securely">
    Use secure storage (Keychain, encrypted preferences). Never localStorage for sensitive apps.
  </Accordion>
  
  <Accordion title="HTTPS Only">
    All API requests must use HTTPS. Tokens sent over HTTP can be intercepted.
  </Accordion>
  
  <Accordion title="Token Revocation">
    Revoke tokens when logging out or if compromise is suspected.
  </Accordion>
  
  <Accordion title="Short-Lived Sessions">
    Web sessions expire based on server configuration. Re-authenticate as needed.
  </Accordion>
</AccordionGroup>

### Revoking Tokens

Users can revoke all tokens from account settings, or revoke specific sessions.

---

## Authentication Errors

| Status | Meaning | Solution |
|--------|---------|----------|
| 401 | Unauthenticated | Token missing, invalid, or expired |
| 403 | Forbidden | User lacks permission for this resource |
| 419 | Session Expired | CSRF token mismatch (web SPA) |

### Error Response

```json
{
  "message": "Unauthenticated."
}
```

---

## Social Login

BeatPass supports social authentication providers:

| Provider | Available |
|----------|-----------|
| Google | Yes |
| Facebook | Yes |
| Apple | Yes |

Social logins create a BeatPass account and session automatically.

---

## Next Steps

<CardGroup cols={2}>
  <Card title="API Endpoints" icon="code" href="/api/endpoints">
    See available endpoints.
  </Card>
  <Card title="Rate Limits" icon="gauge" href="/api/rate-limits">
    Understand request limits.
  </Card>
</CardGroup>
